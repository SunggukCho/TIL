# 2022 FEconf Track A - @webtoon/psd 라이브러리 개발기

Track A 목차

1. Rescript같이해요

2. **@webtoon/psd 라이브러리 개발기**

3. 프론트엔드 DDD를 만나다 

4. 텍스트 에디터? 그게 뭘 만드는건데? 

5. Edge 컴퓨팅으로 프론트엔드 포텐셜 끌어올리기 



## @webtoon/psd 라이브러리 개발기

- 발표자: 네이버웹툰 - 이동현, 강예형

- 예상 청자: 
- 발표 내용 요약: 



## 라이브러리 개발 배경

웹 어플리케이션에서 포토샵 파일을 읽는 방법?

1. 서버에 업로드하여 파일 분석 후 메타 데이터와 이미지 다운로드
2. 사용자 웹 브라우저에서 바로 파일을 분석



1번의 장단점

- psd-tools라는 유명 라이브러리 사용 가능
- 포토샵 파일 용량이 클 경우 업로드/다운로드 시간 지연

2번의 장단점

- 네트워크 호출 비용 X 
- psd-tools만큼 강력한 라이브러리 부재
- psd.js 라는 포토샵 파일을 다루는 라이브러리가 있긴 하지만 다운로드가 1000정도로 다소 미비함.



#### Psd.js를 선택하지 않고 직접 만든 이유

1. 번들링 용량 
   - mb 단위로 넘어가지 않길 바랬으나 1mb 를 넘어가는 크기

2. 실행 속도
   - 포토샵 파일 하나당 크기가 꽤 큰 편인데 이를 실행하는데 속도가 만족스럽지 않았다.

3. .psb형식 미지원
   - 작가분들이 만든 파일은 용량이 큰 경우가 많아 psd보다 psb파일 형식인 경우도 많았습니다.

4. **한글 미지원 -> 제일 크리티컬한 이슈**
   - 동양권 (한글, 한자) 문자를 지원하지 않는 것은 아시아권에서 비즈니스를 하는 네이버웹툰에는 큰 부담이 되었습니다.



> 따라서 새로 만든 @webtoonpsd 라이브러리는 위 4가지를 모두 만족하는 특성을 가지고 있습니다.



이후 PSD파일 형식을 웹 브라우저에서 어떻게 읽었는지에 대해 PSD파일의 자료구조부터 실제 읽는 코드까지 상세하게 설명해주셨으나 솔직히 그 부분을 잘 이해하지는 못했습니다.



## PSD파서 성능 개선

강예형 연사님으로 바뀐 뒤 PSD파서 성능을 향상시킨 내용을 말씀해주셨습니다.

기존 PSD 라이브러리 파서의 성능은 느렸습니다. 따라서 JS로 재작성하여 성능을 (2x -> 10x)로 개선하였습니다. 이는 큰 파일 하나를 여는데 약 15초 정도 걸리던 것을 1초로 줄인 정도의 개선이었습니다. 하지만 더 빠르게 할 수 없을까?해서 더욱 코드를 최적화 한 내용을 보여주셨습니다.



### 코드 최적화 PROCESS

1. 병목을 찾아라

   psd 파서에서의 병목은 이미지 데이터를 디코딩 하는데 시간을 많이 쏟았습니다. 이것이 병목이라는 점을 찾았습니다.

   psd의 이미지는 run-length encoding (색깔이 같은 픽셀끼리 압축하는데 첫 번째에는 색상값을 그 뒤에는 해당 색상의 갯수를 입력하는 방식)으로 압축이 되어있는데 이것을 디코드 하는데 시간이 오래 걸립니다.

2. 성능을 최적화 하는 기술 선정

   WebAssembly.

   JS의 성능을 뛰어넘어 브라우저에서 고성능 작업을 위한 기술. JS보다 바이트코드를 빠른 해독을 할 수 있음.

3. 문제
   - 문제 1. 라이브러리 이므로 WASM을 서버에서도 읽게 하고 싶고 브라우저에서도 읽을 수 있게 하고 싶음.
   - 문제 2. 번들러(webpack, vite, rollup 등) 마다 WA를 지원하는 방식이 모두 다르다.

4. 문제해결:  **JS와 WASM을 합친다.**

- WASM을 base64 인코딩된 문자로 JS파일 내 상수로 선언.
- 모듈 로딩 시 바이너리 데이터로 변환한 다음 WebAssembly 실행
- 장단점
  - 모든 실행환경과 번들러 지원 가능
  - 모듈 로딩이 오래 걸리고 번들 크기가 커진다.

결과: 10~15% 디코딩 속도 감소



---

출처: https://www.youtube.com/watch?v=jZNk-Ncez6E